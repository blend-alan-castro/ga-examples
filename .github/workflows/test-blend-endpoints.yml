name: Test Blend Labs API Endpoints

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test-blend-apis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test Authentication Status Endpoint
      run: |
        echo "üîê Testing Authentication Status endpoint..."
        response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" -X POST \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          -d '{
            "message": "GitHub Action test",
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "actor": "${{ github.actor }}",
            "event": "${{ github.event_name }}",
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
          }' \
          "https://api.beta.blendlabs.com/authentication-status")
        
        # Extract HTTP status and response body
        http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
        response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
        
        echo "üìä Response Status: $http_status"
        echo "üìÑ Response Body: $response_body"
        
        # Check if request was successful
        if [ "$http_status" -ge 200 ] && [ "$http_status" -lt 300 ]; then
          echo "‚úÖ Authentication Status request successful!"
        else
          echo "‚ùå Authentication Status request failed with status $http_status"
          echo "Response: $response_body"
          exit 1
        fi
        
        # Check for error messages in response body
        if echo "$response_body" | grep -q '"error"'; then
          echo "‚ùå API returned an error: $response_body"
          exit 1
        fi
          
    - name: Test Closings Endpoint
      run: |
        echo "üìã Testing Closings endpoint..."
        response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" -X POST \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          -d '{
            "message": "GitHub Action test for closings",
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "actor": "${{ github.actor }}",
            "event": "${{ github.event_name }}",
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
            "applicationId": "aa9fdaa2-7bf3-4411-a836-c2a46117f5c3"
          }' \
          "https://api.beta.blendlabs.com/close/closings?applicationId=aa9fdaa2-7bf3-4411-a836-c2a46117f5c3")
        
        # Extract HTTP status and response body
        http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
        response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
        
        echo "üìä Response Status: $http_status"
        echo "üìÑ Response Body: $response_body"
        
        # Check if request was successful
        if [ "$http_status" -ge 200 ] && [ "$http_status" -lt 300 ]; then
          echo "‚úÖ Closings request successful!"
        else
          echo "‚ùå Closings request failed with status $http_status"
          echo "Response: $response_body"
          exit 1
        fi
        
        # Check for error messages in response body
        if echo "$response_body" | grep -q '"error"'; then
          echo "‚ùå API returned an error: $response_body"
          exit 1
        fi
          
    - name: Test with different HTTP methods
      run: |
        echo "üîÑ Testing different HTTP methods..."
        
        echo "--- GET Authentication Status ---"
        response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" -X GET \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          "https://api.beta.blendlabs.com/authentication-status")
        
        http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
        response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
        
        echo "GET Auth Status: $http_status - $response_body"
        
        # Fail on 4xx/5xx or error responses
        if [ "$http_status" -ge 400 ] || echo "$response_body" | grep -q '"error"'; then
          echo "‚ùå GET Authentication Status failed"
          exit 1
        fi
          
        echo "--- GET Closings ---"
        response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" -X GET \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          "https://api.beta.blendlabs.com/close/closings?applicationId=aa9fdaa2-7bf3-4411-a836-c2a46117f5c3")
        
        http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
        response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
        
        echo "GET Closings: $http_status - $response_body"
        
        # Fail on 4xx/5xx or error responses
        if [ "$http_status" -ge 400 ] || echo "$response_body" | grep -q '"error"'; then
          echo "‚ùå GET Closings failed"
          exit 1
        fi
          
    - name: Test with verbose output
      run: |
        echo "üîç Testing with verbose output for debugging..."
        curl -X POST \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          -d '{
            "test": true,
            "source": "github-actions",
            "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
          }' \
          "https://api.beta.blendlabs.com/authentication-status" \
          -v \
          --max-time 30 \
          --retry 3 \
          --retry-delay 2
