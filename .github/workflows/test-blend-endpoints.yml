name: Test Blend Labs API Endpoints

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test-blend-apis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test Authentication Status Endpoint
      run: |
        echo "üîê Testing Authentication Status endpoint..."
        echo "üìç Using endpoint: ${{ secrets.API_ENDPOINT }}/authentication-status"
        response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" -X GET \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          -H "blend-target-instance: ${{ secrets.TENANT }}" \
          "${{ secrets.API_ENDPOINT }}/authentication-status")
        
        # Extract HTTP status and response body
        http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
        response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
        
        echo "üìä Response Status: $http_status"
        echo "üìÑ Response Body: $response_body"
        
        # Check if request was successful
        if [ "$http_status" -ge 200 ] && [ "$http_status" -lt 300 ]; then
          echo "‚úÖ Authentication Status request successful!"
        else
          echo "‚ùå Authentication Status request failed with status $http_status"
          echo "Response: $response_body"
          exit 1
        fi
        
        # Check for error messages in response body
        if echo "$response_body" | grep -q '"error"'; then
          echo "‚ùå API returned an error: $response_body"
          exit 1
        fi
          
    - name: Test Closings Endpoint
      run: |
        echo "üìã Testing Closings endpoint..."
        echo "üìç Using endpoint: ${{ secrets.API_ENDPOINT }}/close/closings?applicationId=aa9fdaa2-7bf3-4411-a836-c2a46117f5c3"
        response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" -X GET \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
          -H "blend-target-instance: ${{ secrets.TENANT }}" \
          "${{ secrets.API_ENDPOINT }}/close/closings?applicationId=aa9fdaa2-7bf3-4411-a836-c2a46117f5c3")
        
        # Extract HTTP status and response body
        http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
        response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
        
        echo "üìä Response Status: $http_status"
        echo "üìÑ Response Body: $response_body"
        
        # Check if request was successful
        if [ "$http_status" -ge 200 ] && [ "$http_status" -lt 300 ]; then
          echo "‚úÖ Closings request successful!"
        else
          echo "‚ùå Closings request failed with status $http_status"
          echo "Response: $response_body"
          exit 1
        fi
        
        # Check for error messages in response body
        if echo "$response_body" | grep -q '"error"'; then
          echo "‚ùå API returned an error: $response_body"
          exit 1
        fi
